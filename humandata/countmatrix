#load gene annotation file
#note the species of the annotation file

geneAnnotation <- read.delim("~/Documents/DrKwan/workshopwithdrchowdata/Galaxy61-[ftp___ftp.ebi.ac.uk_pub_databases_gencode_Gencode_human_release_35_gencode.v35.chr_patch_hapl_scaff.annotation.gtf.gz].gff", header = F, comment.char = "#")

#name columns of the annotation file

annotationColumns <- c("Chr", "Source", "Feature", "Start", "End", "Score", "Strand", "Frame", "Group")
colnames(geneAnnotation) <- annotationColumns

#filter for Feature "gene"

filteredAnnotation <- geneAnnotation[geneAnnotation$Feature == "gene",]

#drop columns Seqname Source Score Frame

drop <- c("Source", "Score", "Frame")
annotationFile <- filteredAnnotation[,!(names(filteredAnnotation)%in%drop)]

#calculate gene length

annotationFile <- within(annotationFile, GeneLength <- End-Start)

#extract ensembl gene ID

library(stringr)
library(tidyverse)

tbl <- tibble(temp = annotationFile$Group)
tbl2 <- tbl %>%
  mutate(temp2 = str_sub(temp, 8,-1))
tbl2

tbl3 <- tbl2 %>%
  mutate(temp3 = str_sub(temp2, 2, 16))
tbl3

GeneID <- as.vector(tbl3$temp3)
GeneID

annotationFile <- cbind(annotationFile, GeneID)

#drop Group Feature columns 

drop2 <- c("Feature", "Group")
annotationFile <- annotationFile[,!(names(annotationFile)%in%drop2)]

#use biomaRt to convert ensembl gene ID to Gene Symbol

library(biomaRt)
ensembl <- useMart("ensembl")
datasets <- listDatasets(ensembl)
ensembl <- useDataset("mmusculus_gene_ensembl", mart = ensembl)
mouse_gene_ids <- annotationFile[,6]
foo <- getBM(attributes = c("ensembl_gene_id","external_gene_name"),
             values = mouse_gene_ids,
             mart = ensembl)
colnames(foo) <- c("GeneID", "Gene_Symbol")

#reorder annotationFile

annotationFile <- annotationFile[,c(6, 1, 2, 3, 4, 5)]


#load GeneCount files

noRNA16h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy66-[1].tabular", header=FALSE)
noRNA16h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy70-[2].tabular", header=FALSE)
noRNA16h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy74-[3].tabular", header=FALSE)
noRNA6h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy78-[4].tabular", header=FALSE)
noRNA6h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy82-[5].tabular", header=FALSE)
noRNA6h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy86-[6].tabular", header=FALSE)
pUUC16h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy90-[7].tabular", header=FALSE)
pUUC16h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy94-[8].tabular", header=FALSE)
pUUC16h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy98-[9].tabular", header=FALSE)
pUUC6h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy102-[10].tabular", header=FALSE)
pUUC6h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy106-[11].tabular", header=FALSE)
pUUC6h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy110-[12].tabular", header=FALSE)
R84816h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy114-[13].tabular", header=FALSE)
R84816h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy118-[14].tabular", header=FALSE)
R84816h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy122-[15].tabular", header=FALSE)
R8486h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy126-[16].tabular", header=FALSE)
R8486h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy130-[17].tabular", header=FALSE)
R8486h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy134-[18].tabular", header=FALSE)
vehicle16h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy138-[19].tabular", header=FALSE)
vehicle16h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy142-[20].tabular", header=FALSE)
vehicle16h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy146-[21].tabular", header=FALSE)
vehicle6h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy150-[22].tabular", header=FALSE)
vehicle6h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy154-[23].tabular", header=FALSE)
vehicle6h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy158-[24].tabular", header=FALSE)
xRNA16h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy162-[25].tabular", header=FALSE)
xRNA16h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy166-[26].tabular", header=FALSE)
xRNA16h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy170-[27].tabular", header=FALSE)
xRNA6h_1 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy174-[28].tabular", header=FALSE)
xRNA6h_2 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy178-[29].tabular", header=FALSE)
xRNA6h_3 <- read.delim("/Users/mahejabeennidhi/Documents/DrKwan/workshopwithdrchowdata/Galaxy182-[30].tabular", header=FALSE)

#define function to clean the GeneCounts

GeneCounts <- function(RawCount) {
  Reads <- RawCount[,1:2]
  Reads <- tail(Reads, -4)
  Reads[,1] <- str_sub(Reads[,1], 1, 15)
  colnames(Reads) <- c("GeneID", "Count")
  return(Reads)
}

noRNA16h_1 <- GeneCounts(noRNA16h_1)
noRNA16h_2 <- GeneCounts(noRNA16h_2)
noRNA16h_3 <- GeneCounts(noRNA16h_3) 
noRNA6h_1 <- GeneCounts(noRNA6h_1)
noRNA6h_2 <- GeneCounts(noRNA6h_2)
noRNA6h_3 <- GeneCounts(noRNA6h_3)
pUUC16h_1 <- GeneCounts(pUUC16h_1) 
pUUC16h_2 <- GeneCounts(pUUC16h_2)
pUUC16h_3 <- GeneCounts(pUUC16h_3)
pUUC6h_1 <- GeneCounts(pUUC6h_1) 
pUUC6h_2 <- GeneCounts(pUUC6h_2)
pUUC6h_3 <- GeneCounts(pUUC6h_3)
R84816h_1 <- GeneCounts(R84816h_1)
R84816h_2 <- GeneCounts(R84816h_2)
R84816h_3 <- GeneCounts(R84816h_3)
R8486h_1 <- GeneCounts(R8486h_1)
R8486h_2 <- GeneCounts(R8486h_2)
R8486h_3 <- GeneCounts(R8486h_3)
vehicle16h_1 <- GeneCounts(vehicle16h_1)
vehicle16h_2 <- GeneCounts(vehicle16h_2)
vehicle16h_3 <- GeneCounts(vehicle16h_3)
vehicle6h_1 <- GeneCounts(vehicle6h_1)
vehicle6h_2 <- GeneCounts(vehicle6h_2)
vehicle6h_3 <- GeneCounts(vehicle6h_3)
xRNA16h_1 <- GeneCounts(xRNA16h_1)
xRNA16h_2 <- GeneCounts(xRNA16h_2)
xRNA16h_3 <- GeneCounts(xRNA16h_3)
xRNA6h_1 <- GeneCounts(xRNA6h_1)
xRNA6h_2 <- GeneCounts(xRNA6h_2)
xRNA6h_3 <- GeneCounts(xRNA6h_3)

#join all the datasets

library(dplyr)
countMatrix <- inner_join(noRNA16h_1, noRNA16h_2, by = "GeneID") 
countMatrix <- inner_join(countMatrix, noRNA16h_3, by = "GeneID") 
countMatrix <- inner_join(countMatrix, noRNA6h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, noRNA6h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, noRNA6h_3, by = "GeneID")
countMatrix <- inner_join(countMatrix, pUUC16h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, pUUC16h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, pUUC16h_3, by = "GeneID")
countMatrix <- inner_join(countMatrix, pUUC6h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, pUUC6h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, pUUC6h_3, by = "GeneID")
countMatrix <- inner_join(countMatrix, R84816h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, R84816h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, R84816h_3, by = "GeneID")
countMatrix <- inner_join(countMatrix, R8486h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, R8486h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, R8486h_3, by = "GeneID")
countMatrix <- inner_join(countMatrix, vehicle16h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, vehicle16h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, vehicle16h_3, by = "GeneID")
countMatrix <- inner_join(countMatrix, vehicle6h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, vehicle6h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, vehicle6h_3, by = "GeneID")
countMatrix <- inner_join(countMatrix, xRNA16h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, xRNA16h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, xRNA16h_3, by = "GeneID")
countMatrix <- inner_join(countMatrix, xRNA6h_1, by = "GeneID")
countMatrix <- inner_join(countMatrix, xRNA6h_2, by = "GeneID")
countMatrix <- inner_join(countMatrix, xRNA6h_3, by = "GeneID")

colnames(countMatrix) <- c("GeneID", "noRNA16h_1", "noRNA16h_2", "noRNA16h_3", "noRNA6h_1", "noRNA6h_2", "noRNA6h_3", "pUUC16h_1", "pUUC16h_2", "pUUC16h_3", "pUUC6h_1", "pUUC6h_2", "pUUC6h_3", "R84816h_1", "R84816h_2", "R84816h_3", "R8486h_1", "R8486h_2", "R8486h_3", "vehicle16h_1", "vehicle16h_2", "vehicle16h_3", "vehicle6h_1", "vehicle6h_2", "vehicle6h_3", "xRNA16h_1", "xRNA16h_2", "xRNA16h_3", "xRNA6h_1", "xRNA6h_2", "xRNA6h_3")

#join annotationFile with countmatrix

annotationSymbol <- inner_join(countMatrix, annotationFile, by = "GeneID")

#join annotationSymbol with foo

combinedFile <- inner_join(annotationSymbol, foo, by = "GeneID")

#reorder to get input file

GeneIDremoved <- combinedFile[,2:18]
InputDESeq <- GeneIDremoved[,c(17, 12:16, 2:11)]
